#pragma config(Sensor, S1,     touch,          sensorEV3_Touch)
#pragma config(Sensor, S3,     lightSensor,    sensorEV3_Color)
#pragma config(Sensor, S4,     sonar,          sensorEV3_Ultrasonic)
#pragma config(Motor,  motorB,          mL,            tmotorEV3_Large, PIDControl, encoder)
#pragma config(Motor,  motorC,          mR,            tmotorEV3_Large, PIDControl, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

void turn(int m, int rotations, int speed) {
	// 1 = left 0 = right
	// 1 rotation = 90 degrees

	// stop both motors
	motor[mL] = 0;
	motor[mR] = 0;

	if (m) {
		moveMotorTarget(mL, rotations * 350, speed);
		waitUntilMotorStop(mL);
	} else {
		moveMotorTarget(mR, rotations * 350, speed);
		waitUntilMotorStop(mR);
	}
}
// Set speed of both motors
void setSpeed(int speed) {
  motor[mL] = speed;
  motor[mR] = speed;
}

void findTower() {
		float min = 999;
		//bool first_turn = false;
		int current = getMotorEncoder(mL);

		while (getMotorEncoder(mL) <= current + (350 * 4)) {
			motor[mL] = 30;
			if (getUSDistance(sonar) < min) {
				min =	getUSDistance(sonar);
			}
		}
	 while (getUSDistance(sonar) > (min + 1)) {
	   motor[mL] = 30;
	}
	motor[mL] = 0;
	motor[mR] = 0;
}

void pushTower() {
	while(true) { //add a flag
		motor[mL] = 10;
		motor[mR] = 10;

		if (getUSDistance(sonar) < 7 && getColorReflected(lightSensor) < 14) {
			while(getColorReflected(lightSensor) < 14){ //add a flag
			motor[mL] = 0;
			motor[mR] = 0;
			// set a flag to break the loop
		}
		}
	}
}

task main() {
        moveMotorTarget(mL, 4500, 100);
        moveMotorTarget(mR, 4500, 100);
        waitUntilMotorStop(mL);
        waitUntilMotorStop(mR);
        findTower();
        pushTower();
}
/*
task main() {
	wait1Msec(500);
	int count = 0;
	int white = 0; //flag to check we have moved off black
	bool phase1 = true;

	while(phase1) {
			if (count == 0) {
				// start on black and move in the direction its facing till we reach a black tile
				setSpeed(10);
			}

			if (getColorReflected(lightSensor) <= 14 && white == 1 && count == 0) {
				wait1Msec(500);
				playSound(soundBeepBeep);
  			turn(1, 1, 20); // 90 degree left turn
				count++;
				white = 0;
				setSpeed(40); // we are on first black tile
			}

			// light tiles
			if (getColorReflected(lightSensor) >= 20) {
				white = 1;
			}

			// black squares
			if (getColorReflected(lightSensor) <= 14 && count <= 15 && white == 1) {
				playSound(soundBlip);
				count++;
				white = 0;
			}

			if (count == 15) {
        turn(1, 1, 20);
        moveMotorTarget(mL, 4500, 40);
        moveMotorTarget(mR, 4500, 40);
        waitUntilMotorStop(mL);
        waitUntilMotorStop(mR);
        phase1 = false;
        findTower();
		}
	}
		//setSpeed(0);
    //playSound(soundException);
}*/
